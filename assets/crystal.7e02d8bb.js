function f(t,n){return new RegExp((n?"":"^")+"(?:"+t.join("|")+")"+(n?"$":"\\b"))}function c(t,n,e){return e.tokenize.push(t),t(n,e)}var z=/^(?:[-+/%|&^]|\*\*?|[<>]{2})/,g=/^(?:[=!]~|===|<=>|[<>=!]=?|[|&]{2}|~)/,y=/^(?:\[\][?=]?)/,A=/^(?:\.(?:\.{2})?|->|[?:])/,h=/^[a-z_\u009F-\uFFFF][a-zA-Z0-9_\u009F-\uFFFF]*/,k=/^[A-Z_\u009F-\uFFFF][a-zA-Z0-9_\u009F-\uFFFF]*/,E=f(["abstract","alias","as","asm","begin","break","case","class","def","do","else","elsif","end","ensure","enum","extend","for","fun","if","include","instance_sizeof","lib","macro","module","next","of","out","pointerof","private","protected","rescue","return","require","select","sizeof","struct","super","then","type","typeof","uninitialized","union","unless","until","when","while","with","yield","__DIR__","__END_LINE__","__FILE__","__LINE__"]),T=f(["true","false","nil","self"]),Z=f(["def","fun","macro","class","module","struct","lib","enum","union","do","for"]),N=f(["if","unless","case","while","until","begin","then"]),v=["end","else","elsif","rescue","ensure"],O=f(v),S=["\\)","\\}","\\]"],D=new RegExp("^(?:"+S.join("|")+")$"),w={def:x,fun:x,macro:function(t,n){if(t.eatSpace())return null;var e;if(e=t.match(h)){if(e=="def")return"keyword";t.eat(/[?!]/)}return n.tokenize.pop(),"def"},class:l,module:l,struct:l,lib:l,enum:l,union:l},_={"[":"]","{":"}","(":")","<":">"};function I(t,n){if(t.eatSpace())return null;if(n.lastToken!="\\"&&t.match("{%",!1))return c(s("%","%"),t,n);if(n.lastToken!="\\"&&t.match("{{",!1))return c(s("{","}"),t,n);if(t.peek()=="#")return t.skipToEnd(),"comment";var e,u,a;if(t.match(h))return t.eat(/[?!]/),e=t.current(),t.eat(":")?"atom":n.lastToken=="."?"property":E.test(e)?(Z.test(e)?e=="fun"&&n.blocks.indexOf("lib")>=0||e=="def"&&n.lastToken=="abstract"||(n.blocks.push(e),n.currentIndent+=1):n.lastStyle!="operator"&&n.lastStyle||!N.test(e)?e=="end"&&(n.blocks.pop(),n.currentIndent-=1):(n.blocks.push(e),n.currentIndent+=1),w.hasOwnProperty(e)&&n.tokenize.push(w[e]),"keyword"):T.test(e)?"atom":"variable";if(t.eat("@"))return t.peek()=="["?c(p("[","]","meta"),t,n):(t.eat("@"),t.match(h)||t.match(k),"propertyName");if(t.match(k))return"tag";if(t.eat(":"))return t.eat('"')?c(b('"',"atom",!1),t,n):t.match(h)||t.match(k)||t.match(z)||t.match(g)||t.match(y)?"atom":(t.eat(":"),"operator");if(t.eat('"'))return c(b('"',"string",!0),t,n);if(t.peek()=="%"){var r,o="string",d=!0;if(t.match("%r"))o="string.special",r=t.next();else if(t.match("%w"))d=!1,r=t.next();else if(t.match("%q"))d=!1,r=t.next();else if(r=t.match(/^%([^\w\s=])/))r=r[1];else{if(t.match(/^%[a-zA-Z_\u009F-\uFFFF][\w\u009F-\uFFFF]*/))return"meta";if(t.eat("%"))return"operator"}return _.hasOwnProperty(r)&&(r=_[r]),c(b(r,o,d),t,n)}return(e=t.match(/^<<-('?)([A-Z]\w*)\1/))?c((u=e[2],a=!e[1],function(i,m){if(i.sol()&&(i.eatSpace(),i.match(u)))return m.tokenize.pop(),"string";for(var F=!1;i.peek();)if(F)i.next(),F=!1;else{if(i.match("{%",!1))return m.tokenize.push(s("%","%")),"string";if(i.match("{{",!1))return m.tokenize.push(s("{","}")),"string";if(a&&i.match("#{",!1))return m.tokenize.push(p("#{","}","meta")),"string";F=a&&i.next()=="\\"}return"string"}),t,n):t.eat("'")?(t.match(/^(?:[^']|\\(?:[befnrtv0'"]|[0-7]{3}|u(?:[0-9a-fA-F]{4}|\{[0-9a-fA-F]{1,6}\})))/),t.eat("'"),"atom"):t.eat("0")?(t.eat("x")?t.match(/^[0-9a-fA-F_]+/):t.eat("o")?t.match(/^[0-7_]+/):t.eat("b")&&t.match(/^[01_]+/),"number"):t.eat(/^\d/)?(t.match(/^[\d_]*(?:\.[\d_]+)?(?:[eE][+-]?\d+)?/),"number"):t.match(z)?(t.eat("="),"operator"):t.match(g)||t.match(A)?"operator":(e=t.match(/[({[]/,!1))?c(p(e=e[0],_[e],null),t,n):t.eat("\\")?(t.next(),"meta"):(t.next(),null)}function p(t,n,e,u){return function(a,r){if(!u&&a.match(t))return r.tokenize[r.tokenize.length-1]=p(t,n,e,!0),r.currentIndent+=1,e;var o=I(a,r);return a.current()===n&&(r.tokenize.pop(),r.currentIndent-=1,o=e),o}}function s(t,n,e){return function(u,a){return!e&&u.match("{"+t)?(a.currentIndent+=1,a.tokenize[a.tokenize.length-1]=s(t,n,!0),"meta"):u.match(n+"}")?(a.currentIndent-=1,a.tokenize.pop(),"meta"):I(u,a)}}function x(t,n){return t.eatSpace()?null:(t.match(h)?t.eat(/[!?]/):t.match(z)||t.match(g)||t.match(y),n.tokenize.pop(),"def")}function l(t,n){return t.eatSpace()?null:(t.match(k),n.tokenize.pop(),"def")}function b(t,n,e){return function(u,a){for(var r=!1;u.peek();)if(r)u.next(),r=!1;else{if(u.match("{%",!1))return a.tokenize.push(s("%","%")),n;if(u.match("{{",!1))return a.tokenize.push(s("{","}")),n;if(e&&u.match("#{",!1))return a.tokenize.push(p("#{","}","meta")),n;var o=u.next();if(o==t)return a.tokenize.pop(),n;r=e&&o=="\\"}return n}}const L={startState:function(){return{tokenize:[I],currentIndent:0,lastToken:null,lastStyle:null,blocks:[]}},token:function(t,n){var e=n.tokenize[n.tokenize.length-1](t,n),u=t.current();return e&&e!="comment"&&(n.lastToken=u,n.lastStyle=e),e},indent:function(t,n,e){return n=n.replace(/^\s*(?:\{%)?\s*|\s*(?:%\})?\s*$/g,""),O.test(n)||D.test(n)?e.unit*(t.currentIndent-1):e.unit*t.currentIndent},languageData:{indentOnInput:f(S.concat(v),!0),commentTokens:{line:"#"}}};export{L as crystal};
