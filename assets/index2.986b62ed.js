import{y as V,k as j,s as z,a as b,b as E,L as $,j as M,S as O,U as f,c as m,J as R,D as G,$ as J,P as x}from"./Editor.2aa5a3f1.js";import"./MarkdownEditor.umd.6e7ef77c.js";import"./vendor.c2056232.js";import"./index.d60f6a07.js";function A(a,t,s,i=0,n=0){t==null&&(t=a.search(/[^\s\u00a0]/))==-1&&(t=a.length);let e=n;for(let r=i;r<t;r++)a.charCodeAt(r)==9?e+=s-e%s:e++;return e}class L{constructor(t,s,i){this.string=t,this.tabSize=s,this.indentUnit=i,this.pos=0,this.start=0,this.lastColumnPos=0,this.lastColumnValue=0}eol(){return this.pos>=this.string.length}sol(){return this.pos==0}peek(){return this.string.charAt(this.pos)||void 0}next(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)}eat(t){let s,i=this.string.charAt(this.pos);if(s=typeof t=="string"?i==t:i&&(t instanceof RegExp?t.test(i):t(i)),s)return++this.pos,i}eatWhile(t){let s=this.pos;for(;this.eat(t););return this.pos>s}eatSpace(){let t=this.pos;for(;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++this.pos;return this.pos>t}skipToEnd(){this.pos=this.string.length}skipTo(t){let s=this.string.indexOf(t,this.pos);if(s>-1)return this.pos=s,!0}backUp(t){this.pos-=t}column(){return this.lastColumnPos<this.start&&(this.lastColumnValue=A(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue}indentation(){return A(this.string,null,this.tabSize)}match(t,s,i){if(typeof t=="string"){let n=e=>i?e.toLowerCase():e;return n(this.string.substr(this.pos,t.length))==n(t)?(s!==!1&&(this.pos+=t.length),!0):null}{let n=this.string.slice(this.pos).match(t);return n&&n.index>0?null:(n&&s!==!1&&(this.pos+=n[0].length),n)}}current(){return this.string.slice(this.start,this.pos)}}function q(a){if(typeof a!="object")return a;let t={};for(let s in a){let i=a[s];t[s]=i instanceof Array?i.slice():i}return t}class N extends V{constructor(t){let s,i=j(t.languageData),n={token:(e=t).token,blankLine:e.blankLine||(()=>{}),startState:e.startState||(()=>!0),copyState:e.copyState||q,indent:e.indent||(()=>null),languageData:e.languageData||{}};var e;super(i,new class extends z{createParse(r,h,o){return new B(s,r,h,o)}},function(r){let h=b.define({id:c.length,name:"Document",props:[E.add(()=>r)]});return c.push(h),h}(i),[$.of((r,h)=>this.getIndent(r,h))]),s=this,this.streamParser=n,this.stateAfter=new M({perNode:!0})}static define(t){return new N(t)}getIndent(t,s){let i=O(t.state),n=i.resolve(s);for(;n&&n.type!=this.topNode;)n=n.parent;if(!n)return null;let e,r,h=S(this,i,0,n.from,s);if(h?(r=h.state,e=h.pos+1):(r=this.streamParser.startState(t.unit),e=0),s-e>1e4)return null;for(;e<s;){let l=t.state.doc.lineAt(e),g=Math.min(s,l.to);if(l.length){let p=new L(l.text,t.state.tabSize,t.unit);for(;p.pos<g-l.from;)T(this.streamParser.token,p,r)}else this.streamParser.blankLine(r,t.unit);if(g==s)break;e=l.to+1}let{text:o}=t.state.doc.lineAt(s);return this.streamParser.indent(r,/^\s*(.*)/.exec(o)[1],t)}get allowsNesting(){return!1}}function S(a,t,s,i,n){let e=s>=i&&s+t.length<=n&&t.prop(a.stateAfter);if(e)return{state:a.streamParser.copyState(e),pos:s+t.length};for(let r=t.children.length-1;r>=0;r--){let h=t.children[r],o=s+t.positions[r],l=h instanceof f&&o<n&&S(a,h,o,i,n);if(l)return l}return null}function I(a,t,s,i,n){if(n&&s<=0&&i>=t.length)return t;n||t.type!=a.topNode||(n=!0);for(let e=t.children.length-1;e>=0;e--){let r,h=t.positions[e]+s,o=t.children[e];if(h<i&&o instanceof f){if(!(r=I(a,o,s-h,i-h,n)))break;return n?new f(t.type,t.children.slice(0,e).concat(r),t.positions.slice(0,e+1),h+r.length):r}}return null}class B{constructor(t,s,i,n){this.lang=t,this.input=s,this.fragments=i,this.ranges=n,this.stoppedAt=null,this.chunks=[],this.chunkPos=[],this.chunk=[],this.chunkReused=void 0,this.rangeIndex=0,this.to=n[n.length-1].to;let e=x.get(),r=n[0].from,{state:h,tree:o}=function(l,g,p,w){for(let u of g){let y,D=u.from+(u.openStart?25:0),v=u.to-(u.openEnd?25:0),d=D<=p&&v>p&&S(l,u.tree,0-u.offset,p,v);if(d&&(y=I(l,u.tree,p+u.offset,d.pos+u.offset,!1)))return{state:d.state,tree:y}}return{state:l.streamParser.startState(w?m(w):4),tree:f.empty}}(t,i,r,e==null?void 0:e.state);this.state=h,this.parsedPos=this.chunkStart=r+o.length,o.length&&(this.chunks.push(o),this.chunkPos.push(0)),e&&this.parsedPos<e.viewport.from-1e5&&(this.state=this.lang.streamParser.startState(m(e.state)),e.skipUntilInView(this.parsedPos,e.viewport.from),this.parsedPos=e.viewport.from)}advance(){let t=x.get(),s=this.stoppedAt==null?this.to:this.stoppedAt,i=Math.min(s,this.chunkStart+2048);for(t&&(i=Math.min(i,t.viewport.to));this.parsedPos<i;)this.parseLine(t);return this.chunkStart<this.parsedPos&&this.finishChunk(),this.parsedPos>=s?this.finish():t&&this.parsedPos>t.viewport.to?(t.skipUntilInView(this.parsedPos,s),this.finish()):null}stopAt(t){this.stoppedAt=t}lineAfter(t){let s=this.input.chunk(t);if(this.input.lineChunks)s==`
`&&(s="");else{let i=s.indexOf(`
`);i>-1&&(s=s.slice(0,i))}return t+s.length<=this.to?s:s.slice(0,this.to-t)}nextLine(){let t=this.parsedPos,s=this.lineAfter(t),i=t+s.length;for(let n=this.rangeIndex;;){let e=this.ranges[n].to;if(e>=i||(s=s.slice(0,e-(i-s.length)),n++,n==this.ranges.length))break;let r=this.ranges[n].from,h=this.lineAfter(r);s+=h,i=r+h.length}return{line:s,end:i}}skipGapsTo(t,s,i){for(;;){let n=this.ranges[this.rangeIndex].to,e=t+s;if(i>0?n>e:n>=e)break;s+=this.ranges[++this.rangeIndex].from-n}return s}emitToken(t,s,i,n,e){if(this.ranges.length>1){s+=e=this.skipGapsTo(s,e,1);let r=this.chunk.length;i+=e=this.skipGapsTo(i,e,-1),n+=this.chunk.length-r}return this.chunk.push(t,s,i,n),e}parseLine(t){let{line:s,end:i}=this.nextLine(),n=0,{streamParser:e}=this.lang,r=new L(s,t?t.state.tabSize:4,t?m(t.state):2);if(r.eol())e.blankLine(this.state,r.indentUnit);else for(;!r.eol();){let h=T(e.token,r,this.state);h&&(n=this.emitToken(U(h),this.parsedPos+r.start,this.parsedPos+r.pos,4,n))}this.parsedPos=i,this.parsedPos<this.to&&this.parsedPos++}finishChunk(){let t=f.build({buffer:this.chunk,start:this.chunkStart,length:this.parsedPos-this.chunkStart,nodeSet:W,topID:0,maxBufferLength:2048,reused:this.chunkReused});t=new f(t.type,t.children,t.positions,t.length,[[this.lang.stateAfter,this.lang.streamParser.copyState(this.state)]]),this.chunks.push(t),this.chunkPos.push(this.chunkStart-this.ranges[0].from),this.chunk=[],this.chunkReused=void 0,this.chunkStart=this.parsedPos}finish(){return new f(this.lang.topNode,this.chunks,this.chunkPos,this.parsedPos-this.ranges[0].from).balance()}}function T(a,t,s){t.start=t.pos;for(let i=0;i<10;i++){let n=a(t,s);if(t.pos>t.start)return n}throw new Error("Stream parser failed to advance stream.")}const P=Object.create(null),c=[b.none],W=new G(c),C=[];function U(a){return a?P[a]||(P[a]=function(t){let s=null;for(let e of t.split(".")){let r=J[e];r?typeof r=="function"?s?s=r(s):k(e,`Modifier ${e} used at start of tag`):s?k(e,`Tag ${e} used as modifier`):s=r:k(e,`Unknown highlighting tag ${e}`)}if(!s)return 0;let i=t.replace(/ /g,"_"),n=b.define({id:c.length,name:i,props:[R({[i]:s})]});return c.push(n),n.id}(a)):0}for(let[a,t]of[["variable","variableName"],["variable-2","variableName.special"],["string-2","string.special"],["def","variableName.definition"],["tag","typeName"],["attribute","propertyName"],["type","typeName"],["builtin","variableName.standard"],["qualifier","modifier"],["error","invalid"],["header","heading"],["property","propertyName"]])P[a]=U(t);function k(a,t){C.indexOf(a)>-1||(C.push(a),console.warn(t))}export{N as StreamLanguage,L as StringStream};
